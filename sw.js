self.addEventListener('install',()=>{self.skipWaiting()})
self.addEventListener('activate',e=>{e.waitUntil(self.clients.claim())})

async function loadMap(){
  try{ const r=await fetch('/encryption.json',{cache:'no-store'}); if(!r.ok) return {files:[]}; return await r.json() }catch(_){ return {files:[]} }
}

function buildPreviewHTML(pathname){
  const esc=(s)=>s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
  const src=pathname
  const name=src.split('/').pop()
  return `<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>字体预览 - ${esc(name)}</title><style>*{margin:0;padding:0;box-sizing:border-box}:root{--bg:#0b1220;--fg:#e2e8f0;--panel:#0f172a;--border:#1f2937;--accent:#60a5fa}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--fg);line-height:1.6}.wrap{max-width:900px;margin:0 auto;padding:2rem}.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem}.title{font-size:1.25rem;color:var(--accent)}.panel{background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:1rem;margin-bottom:1rem}.row{display:flex;gap:1rem;align-items:center}.row input[type=text]{flex:1;padding:.6rem .8rem;border:1px solid var(--border);border-radius:8px;background:transparent;color:var(--fg)}.row input[type=range]{flex:1}.sample{padding:2rem 1.5rem;background:var(--panel);border:1px dashed var(--border);border-radius:10px;text-align:center;word-break:break-word}.meta{margin-top:.5rem;color:#9ca3af;font-size:.9rem}.meta a{color:#9ca3af;text-decoration:none;border-bottom:1px dashed #9ca3af;cursor:pointer}.meta a:hover{color:#fff;border-color:#fff}.toast{position:fixed;right:20px;bottom:20px;background:#10b981;color:#fff;padding:.5rem .75rem;border-radius:8px;box-shadow:0 4px 10px rgba(0,0,0,.2);opacity:0;transform:translateY(10px);} .toast.show{opacity:1;transform:translateY(0);transition:all .25s ease}</style></head><body><div class="wrap"><div class="header"><div class="title">字体预览</div><a class="back" href="/index.html" style="color:#9ca3af;text-decoration:none">返回首页</a></div><div class="panel"><div class="row" style="margin-bottom:.75rem"><input id="text" type="text" placeholder="输入要预览的文字" value="The quick brown fox jumps over the lazy dog 1234567890 你好，世界！"></div><div class="row"><span style="min-width:90px">字体大小</span><input id="size" type="range" min="12" max="160" value="48"><span id="size-val" style="min-width:60px;text-align:right">48px</span></div></div><div class="sample" id="sample">示例文本</div><div class="meta" id="meta"></div></div><script> (function(){ const src='${esc(src)}'; const fmt = (s)=> s.endsWith('.woff2')?'woff2': s.endsWith('.woff')?'woff': s.endsWith('.otf')?'opentype':'truetype'; const fam='PreviewFont_'+Date.now(); const style=document.createElement('style'); style.textContent='@font-face{font-family:'+fam+';src:url("'+src+'") format("'+fmt(src)+'");font-display:swap}'; document.head.appendChild(style); const sample=document.getElementById('sample'); const input=document.getElementById('text'); const size=document.getElementById('size'); const sizeVal=document.getElementById('size-val'); sample.style.fontFamily=fam; sample.textContent=input.value; sizeVal.textContent=size.value+'px'; sample.style.fontSize=size.value+'px'; input.addEventListener('input',function(){sample.textContent=input.value}); size.addEventListener('input',function(){sizeVal.textContent=size.value+'px';sample.style.fontSize=size.value+'px'}); const abs=location.origin+src; const meta=document.getElementById('meta'); meta.innerHTML='源文件: <a id="src-link" href="'+abs+'">'+abs+'</a>'; const link=document.getElementById('src-link'); link.addEventListener('click',function(e){ e.preventDefault(); navigator.clipboard.writeText(abs).then(function(){ const t=document.createElement('div'); t.className='toast'; t.textContent='Copied!'; document.body.appendChild(t); setTimeout(function(){t.classList.add('show')},10); setTimeout(function(){t.classList.remove('show'); setTimeout(function(){t.remove()},250)},1500); }); }); })(); </script></body></html>`
}

self.addEventListener('fetch',event=>{
  const url=new URL(event.request.url)
  if(event.request.mode==='navigate'){
    event.respondWith((async()=>{
      const map=await loadMap()
      const entry=(map.files||[]).find(f=>f.path===url.pathname)
      if(entry && entry.method==='aes'){
        const html=`<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>受保护内容</title><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#0b1220;color:#e2e8f0;line-height:1.6}.wrap{max-width:900px;margin:0 auto;padding:2rem}.panel{background:#0f172a;border:1px solid #1f2937;border-radius:10px;padding:1rem;margin-bottom:1rem}.row{display:flex;gap:1rem;align-items:center}.row input{flex:1;padding:.6rem .8rem;border:1px solid #1f2937;border-radius:8px;background:transparent;color:#e2e8f0}.actions{display:flex;gap:.75rem;margin-top:.75rem}.btn{padding:.5rem 1rem;border:2px solid #1f2937;border-radius:6px;background:#0f172a;color:#e2e8f0;cursor:pointer;display:inline-flex;align-items:center;gap:.5rem}.btn:hover{transform:translateY(-1px)}.sample{padding:2rem 1.5rem;background:#0f172a;border:1px dashed #1f2937;border-radius:10px;text-align:center;word-break:break-word}.meta{margin-top:.5rem;color:#9ca3af;font-size:.9rem}.meta a{color:#9ca3af;text-decoration:none;border-bottom:1px dashed #9ca3af;cursor:pointer}.meta a:hover{color:#fff;border-color:#fff}.toast{position:fixed;right:20px;bottom:20px;background:#10b981;color:#fff;padding:.5rem .75rem;border-radius:8px;box-shadow:0 4px 10px rgba(0,0,0,.2);opacity:0;transform:translateY(10px);} .toast.show{opacity:1;transform:translateY(0);transition:all .25s ease}</style></head><body><div class="wrap"><div class="panel"><div class="row"><input id="pwd" type="password" placeholder="输入密码以解锁"></div><div class="actions"><button id="unlock" class="btn"><i class="fas fa-lock"></i><span>解锁</span></button><button id="download" class="btn" style="display:none"><i class="fas fa-download"></i><span>下载</span></button></div></div><div class="sample" id="sample" style="display:none"></div><div class="meta" id="meta"></div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script><script>(function(){ function hexToWA(h){ return CryptoJS.enc.Hex.parse(h)} function b64ToWA(b){ return CryptoJS.enc.Base64.parse(b)} function waToU8(wa){ var words=wa.words; var sigBytes=wa.sigBytes; var u8=new Uint8Array(sigBytes); for(var i=0;i<sigBytes;i++){ u8[i]=(words[i>>>2]>>>((3 - i%4)*8))&0xff } return u8 } function decryptAES(data,pwd){ var salt=hexToWA(data.salt); var iv=hexToWA(data.iv); var key=CryptoJS.PBKDF2(pwd,salt,{keySize:256/32,iterations:600000,hasher:CryptoJS.algo.SHA256}); var ct=b64ToWA(data.ct); var decrypted=CryptoJS.AES.decrypt({ciphertext:ct},key,{iv:iv,mode:CryptoJS.mode.CBC,padding:CryptoJS.pad.Pkcs7}); return waToU8(decrypted) } var enc='${entry.enc}'; var pathname='${url.pathname}'; var unlock=document.getElementById('unlock'); var pwd=document.getElementById('pwd'); var sample=document.getElementById('sample'); var dl=document.getElementById('download'); unlock.addEventListener('click',function(){ unlock.animate([{transform:'scale(1)'},{transform:'scale(1.08)'},{transform:'scale(1)'}],{duration:450,easing:'cubic-bezier(.28,.84,.42,1)'}); fetch(enc).then(function(r){return r.json()}).then(function(j){ var u8=decryptAES(j,pwd.value||''); var blob=new Blob([u8]); var ext=pathname.split('.').pop().toLowerCase(); if(['ttf','otf','woff','woff2'].includes(ext)){ var fmt=ext==='woff2'?'woff2':ext==='woff'?'woff':ext==='otf'?'opentype':'truetype'; var fam='Unlocked_'+Date.now(); var s=document.createElement('style'); s.textContent='@font-face{font-family:'+fam+';src:url('+URL.createObjectURL(blob)+') format("'+fmt+'");font-display:swap}'; document.head.appendChild(s); sample.style.display='block'; sample.style.fontFamily=fam; sample.style.fontSize='48px'; sample.textContent='示例文本：The quick brown fox 123 你好'; dl.style.display='inline-flex'; dl.onclick=function(){ var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=pathname.split('/').pop(); document.body.appendChild(a); a.click(); a.remove() } } else if(['png','jpg','jpeg','gif','webp','svg','bmp'].includes(ext)){ var url=URL.createObjectURL(blob); sample.style.display='block'; sample.innerHTML='<img src="'+url+'" style="max-width:100%">'; dl.style.display='inline-flex'; dl.onclick=function(){ var a=document.createElement('a'); a.href=url; a.download=pathname.split('/').pop(); document.body.appendChild(a); a.click(); a.remove() } } else { var url=URL.createObjectURL(blob); sample.style.display='block'; sample.innerHTML='文件已解锁，可下载'; dl.style.display='inline-flex'; dl.onclick=function(){ var a=document.createElement('a'); a.href=url; a.download=pathname.split('/').pop(); document.body.appendChild(a); a.click(); a.remove() } } }).catch(function(){ alert('解密失败') }) }); var abs=location.origin+pathname; var meta=document.getElementById('meta'); meta.innerHTML='受保护的文件: <a id="src-link" href="'+abs+'">'+abs+'</a>'; var link=document.getElementById('src-link'); link.addEventListener('click',function(e){ e.preventDefault(); navigator.clipboard.writeText(abs).then(function(){ var t=document.createElement('div'); t.className='toast'; t.textContent='Copied!'; document.body.appendChild(t); setTimeout(function(){t.classList.add('show')},10); setTimeout(function(){t.classList.remove('show'); setTimeout(function(){t.remove()},250)},1500); }); }); })();</script></body></html>`
        return new Response(html,{headers:{'Content-Type':'text/html; charset=utf-8'}})
      }
      if(/\.(ttf|otf|woff2?|TTF|OTF|WOFF2?)$/.test(url.pathname)){
        return new Response(buildPreviewHTML(url.pathname),{headers:{'Content-Type':'text/html; charset=utf-8'}})
      }
      return fetch(event.request)
    })())
    return
  }
})