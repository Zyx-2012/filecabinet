self.addEventListener('install',()=>{self.skipWaiting()})
self.addEventListener('activate',e=>{e.waitUntil(self.clients.claim())})

function buildFontPreviewHTML(pathname){
  const esc=(s)=>s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
  const src=pathname
  const name=src.split('/').pop()
  return `<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>filecabinet - 字体预览 - ${esc(name)}</title><style>*{margin:0;padding:0;box-sizing:border-box}:root{--bg:#0b1220;--fg:#e2e8f0;--panel:#0f172a;--border:#1f2937;--accent:#60a5fa}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--fg);line-height:1.6}.wrap{max-width:900px;margin:0 auto;padding:2rem}.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem}.title{font-size:1.25rem;color:var(--accent)}.panel{background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:1rem;margin-bottom:1rem}.row{display:flex;gap:1rem;align-items:center}.row input[type=text]{flex:1;padding:.6rem .8rem;border:1px solid var(--border);border-radius:8px;background:transparent;color:var(--fg)}.row input[type=range]{flex:1}.sample{padding:2rem 1.5rem;background:var(--panel);border:1px dashed var(--border);border-radius:10px;text-align:center;word-break:break-word}.meta{margin-top:.5rem;color:#9ca3af;font-size:.9rem}.btn{padding:.5rem 1rem;border:2px solid var(--border);border-radius:6px;background:var(--panel);color:var(--fg);text-decoration:none;display:inline-flex;align-items:center;gap:.5rem}.btn:hover{transform:translateY(-1px)}</style></head><body><div class="wrap"><div class="header"><div class="title">filecabinet 字体预览</div><a class="btn" href="/index.html">返回首页</a></div><div class="panel"><div class="row" style="margin-bottom:.75rem"><input id="text" type="text" placeholder="输入要预览的文字" value="The quick brown fox jumps over the lazy dog 1234567890 你好，世界！"></div><div class="row"><span style="min-width:90px">字体大小</span><input id="size" type="range" min="12" max="200" value="42"><a id="download" class="btn" href="${esc(src)}" download="${esc(name)}">下载</a></div></div><div id="sample" class="sample" style="font-size:42px">The quick brown fox jumps over the lazy dog 1234567890 你好，世界！</div><div class="meta">文件名：${esc(name)} · 源地址：${esc(src)}</div></div><script>const fontName='PreviewFont';const st=document.createElement('style');st.textContent=`@font-face{font-family:${fontName};src:url('${esc(src)}');font-display:swap}`;document.head.appendChild(st);const sample=document.getElementById('sample');sample.style.fontFamily=fontName;document.getElementById('size').addEventListener('input',function(){sample.style.fontSize=this.value+'px'});document.getElementById('text').addEventListener('input',function(){sample.textContent=this.value});</script></body></html>`
}

function buildTextPreviewHTML(pathname){
  const esc=(s)=>s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
  const name=pathname.split('/').pop()
  return `<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>文本预览 - ${esc(name)}</title><style>*{margin:0;padding:0;box-sizing:border-box}:root{--bg:#0b1220;--fg:#e2e8f0;--panel:#0f172a;--border:#1f2937;--accent:#60a5fa}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--fg);line-height:1.6}.wrap{max-width:900px;margin:0 auto;padding:2rem}.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem}.title{font-size:1.25rem;color:var(--accent)}.panel{background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:1rem;margin-bottom:1rem}.btn{padding:.5rem 1rem;border:2px solid var(--border);border-radius:6px;background:var(--panel);color:var(--fg);text-decoration:none;display:inline-flex;align-items:center;gap:.5rem}.btn:hover{transform:translateY(-1px)}pre{background:var(--panel);border:1px dashed var(--border);border-radius:10px;padding:1rem;white-space:pre-wrap;word-break:break-word}</style></head><body><div class="wrap"><div class="header"><div class="title">文本预览</div><a class="btn" href="/index.html">返回</a></div><div class="panel" style="display:flex;gap:.5rem;align-items:center"><select id="enc"><option value="auto">自动识别</option><option value="utf-8">UTF-8</option><option value="utf-16le">UTF-16 LE</option><option value="utf-16be">UTF-16 BE</option><option value="gb18030">GB18030</option><option value="gbk">GBK</option><option value="big5">Big5</option></select><button id="copy" class="btn">复制</button><button id="download" class="btn">下载</button></div><pre id="code">加载中...</pre></div><script>(async()=>{const url='${esc(pathname)}';const r=await fetch(url,{cache:'no-store'});const b=await r.arrayBuffer();const u=new Uint8Array(b);function hasBOM(bytes){if(bytes.length>=3&&bytes[0]===0xEF&&bytes[1]===0xBB&&bytes[2]===0xBF) return 'utf-8'; if(bytes.length>=2&&bytes[0]===0xFE&&bytes[1]===0xFF) return 'utf-16be'; if(bytes.length>=2&&bytes[0]===0xFF&&bytes[1]===0xFE) return 'utf-16le'; return null}function score(str){let bad=0;for(let i=0;i<str.length;i++) if(str.charCodeAt(i)===0xFFFD) bad++;return bad/Math.max(1,str.length)}function tryDecode(label){try{const dec=new TextDecoder(label,{fatal:false});return dec.decode(u)}catch(_){return null}}function auto(){const bom=hasBOM(u);if(bom){let s=tryDecode(bom);if(bom==='utf-8'&&s) s=s.replace(/^\uFEFF/, ''); return {label:bom,text:s}}const cands=['utf-8','gb18030','gbk','big5'];let best={label:'utf-8',text:'',score:1e9};for(const lab of cands){const t=tryDecode(lab);if(t==null) continue;const sc=score(t);if(sc<best.score){best={label:lab,text:t,score:sc}}}return {label:best.label,text:best.text}}let cur=auto();const pre=document.getElementById('code');pre.textContent=cur.text||'';document.getElementById('enc').value='auto';document.getElementById('enc').addEventListener('change',e=>{const v=e.target.value;if(v==='auto'){cur=auto()}else{const t=tryDecode(v)||cur.text;cur={label:v,text:t}}pre.textContent=cur.text});document.getElementById('copy').addEventListener('click',()=>{navigator.clipboard.writeText(pre.textContent||'').catch(()=>{})});document.getElementById('download').addEventListener('click',()=>{const blob=new Blob([pre.textContent||''],{type:'text/plain;charset='+cur.label});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='${esc(name)}';document.body.appendChild(a);a.click();a.remove();});})();</script></body></html>`
}

self.addEventListener('fetch',event=>{
  const url=new URL(event.request.url)
  if(event.request.mode==='navigate'){
    event.respondWith((async()=>{
      if(/\.(ttf|otf|woff2?|TTF|OTF|WOFF2?)$/.test(url.pathname)){
        return fetch(event.request)
      }
      return fetch(event.request)
    })())
  }
})
